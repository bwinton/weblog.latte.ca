<p>As I <a href="http://weblog.latte.ca/firstpost.html">mentioned
before</a>, we got a Mac Mini.  It's been a bit of a pain getting it all
set up, but I think we're finally done.  The web server is moved over,
along with all the websites.  The mail server is moved over, and I took
the opportunity to delete my mother's account.  (That's not as bad as it
sounds.  She had it redirecting to GMail anyways, and the error message
says as much.  Of course, since I haven't told her about it yet, this
will probably come as a bit of a surprise.)  Uh, and that turned out to
be all the servers I was running.  Well, I was running CherryPy, and
some other stuff, but it wasn't particularly important, and I've found
better ways of doing it, for the most part.</p>
<p>But that's not really why I'm posting here.  I'm posting here because
I got some cool Python stuff working under the Mac, and I wanted to
share it.  Specifically, I (or rather, my wife and I) wanted to have a
window showing on the login screen, displaying <a
href="http://weatheroffice.ec.gc.ca/city/pages/on-143_metric_e.html">the
weather</a>.  After several bits of trial and error, and liberal
"borrowing" from <a href="http://livingcode.org/">Dethe Elza</a>'s <a
href="http://livingcode.org/project/pastels/">Pastels project</a> I
finally got something which would do what I wanted.  First, the code:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</pre></div></td><td class="code"><pre class="code literal-block"><span></span><span class="kn">from</span> <span class="nn">AppKit</span> <span class="kn">import</span> <span class="n">NSObject</span><span class="p">,</span> <span class="n">NSApplication</span><span class="p">,</span> <span class="n">NSTimer</span><span class="p">,</span> <span class="n">NSApp</span><span class="p">,</span> <span class="n">NSURL</span>
<span class="kn">from</span> <span class="nn">AppKit</span> <span class="kn">import</span> <span class="n">NSURLRequest</span><span class="p">,</span> <span class="n">NSWindow</span><span class="p">,</span> <span class="n">NSTitledWindowMask</span>
<span class="kn">from</span> <span class="nn">AppKit</span> <span class="kn">import</span> <span class="n">NSClosableWindowMask</span><span class="p">,</span> <span class="n">NSMiniaturizableWindowMask</span>
<span class="kn">from</span> <span class="nn">AppKit</span> <span class="kn">import</span> <span class="n">NSResizableWindowMask</span><span class="p">,</span> <span class="n">NSBackingStoreBuffered</span>
<span class="kn">from</span> <span class="nn">BeautifulSoup</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">PyObjCTools</span> <span class="kn">import</span> <span class="n">AppHelper</span>
<span class="kn">from</span> <span class="nn">WebKit</span> <span class="kn">import</span> <span class="n">WebView</span><span class="p">,</span> <span class="n">WebDataSource</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib</span>

<span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">620</span><span class="p">,</span> <span class="mi">540</span>

<span class="k">def</span> <span class="nf">Window</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">NSWindow</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span><span class="o">.</span><span class="n">initWithContentRect_styleMask_backing_defer_</span><span class="p">(</span>
        <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">)),</span>
        <span class="n">NSTitledWindowMask</span> <span class="o">|</span>
        <span class="n">NSClosableWindowMask</span> <span class="o">|</span> 
        <span class="n">NSMiniaturizableWindowMask</span> <span class="o">|</span>
        <span class="n">NSResizableWindowMask</span><span class="p">,</span>
        <span class="n">NSBackingStoreBuffered</span><span class="p">,</span>
        <span class="bp">False</span><span class="p">)</span>
    <span class="n">window</span><span class="o">.</span><span class="n">setTitle_</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">view</span><span class="p">:</span>
        <span class="n">window</span><span class="o">.</span><span class="n">setContentView_</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>
    <span class="n">window</span><span class="o">.</span><span class="n">orderFront_</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">window</span>

<span class="k">class</span> <span class="nc">MyAppDelegate</span><span class="p">(</span><span class="n">NSObject</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">timer</span> <span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wUrl</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span> <span class="n">y</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">mainFrame</span><span class="p">()</span><span class="o">.</span><span class="n">loadHTMLString_baseURL_</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;test&amp;lt;title&amp;gt;%s&amp;lt;head&amp;gt;</span>
<span class="sd">            &amp;lt;body&amp;gt;%s&amp;lt;body&amp;gt;&amp;lt;html&amp;gt;&quot;&quot;&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span> <span class="s1">&#39;style&#39;</span> <span class="p">)]),</span> <span class="n">b</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">div</span><span class="o">.</span><span class="n">div</span><span class="o">.</span><span class="n">div</span><span class="o">.</span><span class="n">div</span><span class="o">.</span><span class="n">div</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wUrl</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">applicationDidFinishLaunching_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notification</span><span class="p">):</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">WebView</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span><span class="o">.</span><span class="n">initWithFrame_</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="s1">&#39;Pastels Test&#39;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_delegate</span> <span class="o">=</span> <span class="n">MyWindowDelegate</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">setDelegate_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_delegate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wUrl</span> <span class="o">=</span> <span class="n">NSURL</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span><span class="o">.</span><span class="n">initWithString_</span><span class="p">(</span>
            <span class="s2">&quot;http://weatheroffice.ec.gc.ca/city/pages/on-143_metric_e.html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="bp">None</span> <span class="p">)</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">NSTimer</span><span class="o">.</span><span class="n">scheduledTimerWithTimeInterval_target_selector_userInfo_repeats_</span><span class="p">(</span>
            <span class="mi">1800</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">True</span> <span class="p">)</span>

<span class="k">class</span> <span class="nc">MyWindowDelegate</span><span class="p">(</span><span class="n">NSObject</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">windowWillClose_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notification</span><span class="p">):</span>
        <span class="n">NSApp</span><span class="p">()</span><span class="o">.</span><span class="n">terminate_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">app_delegate</span> <span class="o">=</span> <span class="n">MyAppDelegate</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">NSApplication</span><span class="o">.</span><span class="n">sharedApplication</span><span class="p">()</span><span class="o">.</span><span class="n">setDelegate_</span><span class="p">(</span><span class="n">app_delegate</span><span class="p">)</span>   
    <span class="n">AppHelper</span><span class="o">.</span><span class="n">runEventLoop</span><span class="p">(</span><span class="n">installInterrupt</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span> <span class="s2">&quot;/dev/console&quot;</span> <span class="p">)[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_UID</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If the console is owned by root, start the app.</span>
            <span class="n">main</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, sleep until it is.</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span> <span class="mi">10</span> <span class="p">)</span>
</pre>
</td></tr></table>

<p><br/>
And next, the launchd plist file that keeps it running:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><pre class="code literal-block"><span></span><span class="ni">&amp;lt;</span>?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>!DOCTYPE plist PUBLIC &quot;-//Apple Computer//DTD PLIST 1.0//EN&quot;
&quot;http://www.apple.
com/DTDs/PropertyList-1.0.dtd&quot;<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>plist version=&quot;1.0&quot;<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>dict<span class="ni">&amp;gt;</span>  
    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>Label<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>string<span class="ni">&amp;gt;</span>ca.latte.update.login.weather<span class="ni">&amp;lt;</span>/string<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>ProgramArguments<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>array<span class="ni">&amp;gt;</span> 
        <span class="ni">&amp;lt;</span>string<span class="ni">&amp;gt;</span>/path/to/test.py<span class="ni">&amp;lt;</span>/string<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>/array<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>ServiceDescription<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>string<span class="ni">&amp;gt;</span>A program to pop up the weather in a box<span class="ni">&amp;lt;</span>/string<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>LowPriorityIO<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>true/<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>RunAtLoad<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>true/<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>OnDemand<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>false/<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>Nice<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>integer<span class="ni">&amp;gt;</span>1<span class="ni">&amp;lt;</span>/integer<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>StandardOutPath<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>string<span class="ni">&amp;gt;</span>/path/to/loginWeather.out<span class="ni">&amp;lt;</span>/string<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>key<span class="ni">&amp;gt;</span>StandardErrorPath<span class="ni">&amp;lt;</span>/key<span class="ni">&amp;gt;</span>
    <span class="ni">&amp;lt;</span>string<span class="ni">&amp;gt;</span>/path/to/loginWeather.err<span class="ni">&amp;lt;</span>/string<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/dict<span class="ni">&amp;gt;</span>
<span class="ni">&amp;lt;</span>/plist<span class="ni">&amp;gt;</span>
</pre>
</td></tr></table>

<p>And there you have it.  Way cooler than my previous attempt, which tried
to write using <tt>sudo defaults write
/Library/Preferences/com.apple.loginwindow LoginwindowText -string
"parsed weather info here"</tt>.</p>
<p>If any of you have any questions, I'ld love to answer them as best I
can. Just comment, and I'll see what I can dig up.  By which I mean
email Dethe, and ask him.  ;)</p>